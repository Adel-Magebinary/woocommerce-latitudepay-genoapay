<?php

namespace Latitude\Tests\Wpunit;
use Codeception\Exception\ModuleException;
use tad\WPBrowser\Module\WPLoader\FactoryStore;


/**
 * Class ReturnActionWithGenoaPayTest
 * @package Latitude\Tests\Wpunit
 */
class VulnerabilityWithGenoaPayTest extends GenoaPay
{
    /**
     * FAIL URL vulnerability test
     * change result from Fail->Success (validate_response_signature route)
     * @test
     */
    public function returnActionShouldFailOnSignatureCheck()
    {
        // Create order and process payment as usual until redirected to Gpay portal
        $this->tester->createApiTokenSuccess();
		$this->tester->createApiPurchaseSuccess();
        WC()->cart->empty_cart();
        WC()->cart->add_to_cart( $this->simple_product->get_id(), 3 );
        WC()->cart->calculate_totals();
        $order = $this->tester->create_order();
        $result = $this->gateway->process_payment($order->get_id()); // order_id and purchase_token in session now
        
        // Return from Gpay portal with failed param
        $_GET = [
            'result' => \BinaryPay_Variable::STATUS_FAILED,
            'message' => 'The customer cancelled the purchase',
            'wc-api' => 'genoapay_return_action',
            'token' => 'xxxxxxxxxxx', 
            'reference' => $order->get_id()
        ];
        $_GET['signature'] = $this->generate_signature($_GET); 

        // User intercepted and changed the result parameter
        $_GET['result'] = \BinaryPay_Variable::STATUS_COMPLETED;

        // return_action() should stop it at signature check
        $this->gateway->return_action();
        $notices = wc_get_notices( 'error' );
        $this->assertIsArray($notices);
        if(is_array($notices[0]) && isset($notices[0]['notice'])){
            $this->assertEquals($notices[0]['notice'], 'The return action handler is not valid for the request.');
        } else {
            $this->assertEquals($notices[0], 'The return action handler is not valid for the request.');
        }
    }

     /**
     * FAIL URL vulnerability test
     * change result from Fail->Success (validate_response_signature route)
     * @test
     */
    public function returnActionShouldFailOnOrderIdCheck()
    {
        // Create order and process payment as usual until redirected to Gpay portal
        $this->tester->createApiTokenSuccess();
		$this->tester->createApiPurchaseSuccess();
        WC()->cart->empty_cart();
        WC()->cart->add_to_cart( $this->simple_product->get_id(), 3 );
        WC()->cart->calculate_totals();
        $orderA = $this->tester->create_order();
        $result = $this->gateway->process_payment($orderA->get_id()); // order_id and purchase_token in session now
        
        // Return from Gpay portal with success param
        $_GET = [
            'result' => \BinaryPay_Variable::STATUS_COMPLETED,
            'message' => 'The customer cancelled the purchase',
            'wc-api' => 'genoapay_return_action',
            'token' => 'xxxxxxxxxxx', 
            'reference' => $orderA->get_id()
        ];
        $_GET['signature'] = $this->generate_signature($_GET); 
    
        // Make sure return action successful
        $this->gateway->return_action();
        $notices = wc_get_notices( 'error' );
        $this->assertEmpty($notices);
        $headers = xdebug_get_headers();
        $this->assertContains(
            "X-Redirect-By: WordPress",
            $headers
        );
        $this->assertRegExp(
            "/order-received/",
            json_encode($headers)
        );

        // Create order and process payment again until gateway
        $this->tester->createApiTokenSuccess();
        $this->tester->createApiPurchaseSuccess();
        WC()->cart->empty_cart();
        WC()->cart->add_to_cart( $this->simple_product->get_id(), 3 );
        WC()->cart->calculate_totals();
        $orderB = $this->tester->create_order();
        $result = $this->gateway->process_payment($orderB->get_id()); // order_id and purchase_token in session updated

        // try to copy and paste success url with old $_GET onto browser
        // return_action() should stop it at order id check
        $this->gateway->return_action();
        $notices = wc_get_notices( 'error' );
        $this->assertIsArray($notices);
        if(is_array($notices[0]) && isset($notices[0]['notice'])){
            $this->assertEquals($notices[0]['notice'], 'The return action handler is not valid for the request.');
        } else {
            $this->assertEquals($notices[0], 'The return action handler is not valid for the request.');
        }
    }
}